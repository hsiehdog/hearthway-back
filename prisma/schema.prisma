generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum GroupType {
  PROJECT
  TRIP
}

enum SplitType {
  EVEN
  PERCENT
  SHARES
}

enum ExpenseStatus {
  PENDING      // no one has paid yet
  PARTIALLY_PAID // some, but not all, of the amount has been paid
  PAID         // paid by payer_id
  REIMBURSED   // optional, for future
}

enum UploadParsingStatus {
  PENDING
  IN_PROGRESS
  SUCCESS
  FAILED
}

model User {
  id            String        @id @default(cuid())
  email         String        @unique
  name          String
  emailVerified Boolean       @default(false) @map("email_verified")
  image         String?
  role          Role          @default(USER)
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  aiSessions    AiSession[]
  authSessions  AuthSession[]
  accounts      AuthAccount[]
  members       GroupMember[]

  @@map("users")
}

model AiSession {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @map("user_id")
  prompt    String
  response  String
  model     String
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@map("ai_sessions")
}

model AuthSession {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")

  @@map("auth_sessions")
}

model AuthAccount {
  id                    String    @id @default(cuid())
  accountId             String    @map("account_id")
  providerId            String    @map("provider_id")
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                String    @map("user_id")
  accessToken           String?   @map("access_token")
  refreshToken          String?   @map("refresh_token")
  idToken               String?   @map("id_token")
  accessTokenExpiresAt  DateTime? @map("access_token_expires_at")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@unique([providerId, accountId])
  @@map("auth_accounts")
}

model AuthVerification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("auth_verifications")
}

model Group {
  id          String        @id @default(cuid()) @map("id")
  name        String        @map("name")
  type        GroupType     @default(PROJECT) @map("type")
  members     GroupMember[]
  expenses    Expense[]
  settlements Settlement[]
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  @@map("groups")
}

model GroupMember {
  id                 String               @id @default(cuid()) @map("id")
  group              Group                @relation(fields: [groupId], references: [id])
  groupId            String               @map("group_id")
  user               User?                @relation(fields: [userId], references: [id])
  userId             String?              @map("user_id")
  displayName        String               @map("display_name")
  email              String?              @map("email")
  participantEntries ExpenseParticipant[] @relation("ExpenseParticipantMember")
  paymentsMade       ExpensePayment[]     @relation("ExpensePaymentPayer")
  settlementsFrom    Settlement[]         @relation("SettlementFrom")
  settlementsTo      Settlement[]         @relation("SettlementTo")
  uploads            UploadedExpense[]    @relation("Uploader")
  createdAt          DateTime             @default(now()) @map("created_at")

  @@index([groupId])
  @@map("group_members")
}

model Expense {
  id           String               @id @default(cuid()) @map("id")
  group        Group                @relation(fields: [groupId], references: [id])
  groupId      String               @map("group_id")
  amount       Decimal              @map("amount") @db.Decimal(12, 2)
  currency     String               @default("USD") @map("currency")
  date         DateTime             @default(now()) @map("date") @db.Date
  name         String               @default("Expense") @map("name")
  description  String?              @map("description")
  status       ExpenseStatus        @default(PENDING) @map("status")
  splitType    SplitType            @map("split_type")
  participants ExpenseParticipant[]
  lineItems    ExpenseLineItem[]
  uploads      UploadedExpense[]
  payments     ExpensePayment[]
  createdAt    DateTime             @default(now()) @map("created_at")

  @@index([groupId])
  @@map("expenses")
}

model ExpenseParticipant {
  id          String      @id @default(cuid()) @map("id")
  expense     Expense     @relation(fields: [expenseId], references: [id])
  expenseId   String      @map("expense_id")
  member      GroupMember @relation("ExpenseParticipantMember", fields: [memberId], references: [id])
  memberId    String      @map("member_id")
  shareAmount Decimal?    @map("share_amount") @db.Decimal(12, 2)

  @@unique([expenseId, memberId])
  @@index([expenseId])
  @@index([memberId])
  @@map("expense_participants")
}

model ExpensePayment {
  id            String        @id @default(cuid()) @map("id")
  expense       Expense       @relation(fields: [expenseId], references: [id])
  expenseId     String        @map("expense_id")
  payer         GroupMember   @relation("ExpensePaymentPayer", fields: [payerId], references: [id])
  payerId       String        @map("payer_id")
  amount        Decimal       @map("amount") @db.Decimal(12, 2)
  currency      String        @default("USD") @map("currency")
  notes          String?      @map("notes")
  receiptUrl    String?       @map("receipt_url")
  paidAt        DateTime      @default(now()) @map("paid_at")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt      @map("updated_at")

  @@index([expenseId])
  @@index([payerId])
  @@map("expense_payments")
}

model ExpenseLineItem {
  id          String   @id @default(cuid()) @map("id")
  expense     Expense  @relation(fields: [expenseId], references: [id])
  expenseId   String   @map("expense_id")
  description String?  @map("description")
  category    String?  @map("category")
  quantity    Decimal  @default(1) @map("quantity") @db.Decimal(10, 2)
  unitAmount  Decimal  @map("unit_amount") @db.Decimal(12, 2)
  totalAmount Decimal  @map("total_amount") @db.Decimal(12, 2)
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([expenseId])
  @@map("expense_line_items")
}

model Settlement {
  id           String      @id @default(cuid()) @map("id")
  group        Group       @relation(fields: [groupId], references: [id])
  groupId      String      @map("group_id")
  fromMember   GroupMember @relation("SettlementFrom", fields: [fromMemberId], references: [id])
  fromMemberId String      @map("from_member_id")
  toMember     GroupMember @relation("SettlementTo", fields: [toMemberId], references: [id])
  toMemberId   String      @map("to_member_id")
  amount       Decimal     @map("amount") @db.Decimal(12, 2)
  currency     String      @default("USD") @map("currency")
  note         String?     @map("note")
  markedPaid   Boolean     @default(false) @map("marked_paid")
  paidAt       DateTime?   @map("paid_at")
  createdAt    DateTime    @default(now()) @map("created_at")

  @@index([groupId])
  @@index([fromMemberId])
  @@index([toMemberId])
  @@map("settlements")
}

model UploadedExpense {
  id               String              @id @default(cuid()) @map("id")
  expense          Expense             @relation(fields: [expenseId], references: [id])
  expenseId        String              @map("expense_id")
  uploadedBy       GroupMember?        @relation("Uploader", fields: [uploadedById], references: [id])
  uploadedById     String?             @map("uploaded_by_id")
  fileUrl          String              @map("file_url")
  fileType         String              @map("file_type")
  originalFileName String              @map("original_file_name")
  storageBucket    String              @map("storage_bucket")
  storageKey       String              @map("storage_key")
  parsingStatus    UploadParsingStatus @default(PENDING) @map("parsing_status")
  rawText          String?             @map("raw_text")
  parsedJson       Json?               @map("parsed_json")
  errorMessage     String?             @map("error_message")
  createdAt        DateTime            @default(now()) @map("created_at")
  updatedAt        DateTime            @updatedAt @map("updated_at")

  @@index([expenseId])
  @@index([uploadedById])
  @@map("uploaded_expenses")
}
